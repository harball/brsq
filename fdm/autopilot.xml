<?xml version="1.0" encoding="utf-8"?>
<!--
################################################################################
#
#             THIS FILE DEFINES THE AUTOPILOT BEHAVIOUR
#
################################################################################

http://www.flightgear.org/Docs/XMLAutopilot/node4.html
file Aircraft/Generic/generic-autopilot-helper.xml

- alpha     Filter time weighing factor (default = 0.1)
- beta      Proportional weighing factor (default = 1)
- gamma     Unfiltered derivative error weighing factor (default = 0)
- Kp        Proportional gain
- Ts        Sampling interval
- Ti        Integrator time
- Td        Derivator time
- u_min     Minimum output value
- u_max     Maximum output value

P : present, le gain agit sur la rapidite de correction
D : futur, permet d anticiper et eviter l overshoot
I : passe, corrige les perturbations

changelog
- 2016-10-22 : create
- 2017-07-20 : total refactoring by Joshua Davidson (it0uchpods)

-->

<PropertyList>

  <!--
________________________________________________________________________________
                                                                           SPEED
  -->

  <!-- ~~~~~~~~~~~~~~~~~~ auto-throttle -->
  <pid-controller>
    <name>IAS Hold</name>
    <debug>false</debug>
    <enable>
      <property>/autopilot/locks/speed</property>
      <value>speed-with-throttle</value>
    </enable>
    <input>
      <property>/instrumentation/airspeed-indicator/true-speed-kt</property>
    </input>
    <reference>
      <property>/instrumentation/my_aircraft/pfd/controls/target-speed-kt</property>
    </reference>
    <output>
      <property>/controls/engines/engine[0]/throttle</property>
      <property>/controls/engines/engine[1]/throttle</property>
    </output>
    <config>
      <Kp>0.1</Kp>
      <Ti>9</Ti>
      <Td>0.001</Td>
      <u_min>0.0</u_min>
      <u_max>1.0</u_max>
    </config>
  </pid-controller>

  <!--
________________________________________________________________________________
                                                                      HORIZONTAL
  -->

  <!-- ~~~~~~~~~~~~~~~~~~ heading bug -->
  <pi-simple-controller>
    <name>Heading Bug Hold (DG based)</name>
    <debug>false</debug>
    <enable>
      <property>/autopilot/locks/heading</property>
      <value>dg-heading-hold</value>
    </enable>
    <input>
      <property>/autopilot/internal/heading-bug-error-deg</property>
      <scale>1.5</scale>
    </input>
    <reference>
      <value>0.0</value>
    </reference>
    <output>
      <property>/autopilot/internal/target-roll-deg</property>
    </output>
    <config>
      <Kp>-1.2</Kp>
      <Ki>0.0</Ki>
      <min>-30.0</min>
      <max>30.0</max>
    </config>
  </pi-simple-controller>
  
  <!-- ~~~~~~~~~~~~~~~~~~ nav radial -->
  <pi-simple-controller>
    <name>NAV 1 Hold</name>
    <debug>false</debug>
    <enable>
      <property>/autopilot/locks/heading</property>
      <value>nav1-hold</value>
    </enable>
    <input>
      <property>autopilot/internal/nav1-heading-error-deg</property>
    </input>
    <reference>
      <value>0.0</value>
    </reference>
    <output>
      <property>autopilot/internal/target-roll-deg</property>
    </output>
    <config>
      <Kp>-1</Kp>
      <Ki>0.00001</Ki>
      <min>-30.0</min>
      <max>30.0</max>
    </config>
  </pi-simple-controller>
  
  <pid-controller>
    <name>system_command_roll</name>
    <debug>false</debug>
    <enable>
      <condition>
        <or>
          <equals>
            <property>/autopilot/locks/heading</property>
            <value>dg-heading-hold</value>
          </equals>
          <equals>
            <property>/autopilot/locks/heading</property>
            <value>nav1-hold</value>
          </equals>
        </or>
      </condition>
    </enable>
    <input>
      <property>/orientation/roll-deg</property>
    </input>
    <reference>
      <property>/autopilot/internal/target-roll-deg</property>
    </reference>
    <output>
      <property>/controls/flight/aileron-ap</property>
    </output>
    <config>
      <Kp>0.005</Kp>
      <Ti>10.0</Ti>
      <Td>0.0001</Td>
      <u_min>-0.4</u_min>
      <u_max>0.4</u_max>
    </config>
  </pid-controller>
  
  <filter>
    <name>System Command: Roll Sync</name>
    <debug>false</debug>
    <type>gain</type>
    <gain>1</gain>
    <enable>
      <condition>
        <and>
          <not-equals>
            <property>/autopilot/locks/heading</property>
            <value>dg-heading-hold</value>
          </not-equals>
          <not-equals>
            <property>/autopilot/locks/heading</property>
            <value>nav1-hold</value>
          </not-equals>
        </and>
      </condition>
    </enable>
    <input>/orientation/roll-deg</input>
    <output>/autopilot/internal/target-roll-deg</output>
    <min>-30.0</min>
    <max>30.0</max>
  </filter>
  
  <filter>
    <name>System Command: Aileron</name>
    <debug>false</debug>
    <type>noise-spike</type>
    <enable>
      <condition>
        <or>
          <equals>
            <property>/autopilot/locks/heading</property>
            <value>dg-heading-hold</value>
          </equals>
          <equals>
            <property>/autopilot/locks/heading</property>
            <value>nav1-hold</value>
          </equals>
        </or>
      </condition>
    </enable>
    <input>controls/flight/aileron-ap</input>
    <output>controls/flight/aileron</output>
    <max-rate-of-change>0.8</max-rate-of-change>
  </filter>

  <!--
________________________________________________________________________________
                                                                        VERTICAL
  -->

  <filter>
    <name>vspeed max</name>
    <debug>false</debug>
    <type>gain</type>
    <gain>-1</gain>
    <input>1</input>
    <reference>
      <property>/instrumentation/my_aircraft/pfd/controls/target-vs</property>
      <abs type="bool">true</abs>
    </reference>
    <output>/instrumentation/my_aircraft/pfd/controls/vs-max</output>
  </filter>
  <filter>
    <name>vspeed min</name>
    <debug>false</debug>
    <type>gain</type>
    <gain>1</gain>
    <input>1</input>
    <reference>
      <property>/instrumentation/my_aircraft/pfd/controls/target-vs</property>
      <abs type="bool">true</abs>
    </reference>
    <output>/instrumentation/my_aircraft/pfd/controls/vs-min</output>
  </filter>
  <predict-simple>
    <name>Altitude 5 Seconds Ahead</name>
    <debug>false</debug>
    <input>/instrumentation/altimeter/indicated-altitude-ft</input>
    <output>/autopilot/internal/altitude-5-sec-ahead</output>
    <seconds>5.0</seconds>
    <filter-gain>0.0</filter-gain>
  </predict-simple>
  
  <!-- ~~~~~~~~~~~~~~~~~~ altitude -->
  <filter>
    <name>Altitude Capture/Hold Difference</name>
    <debug>false</debug>
    <type>gain</type>
    <enable>
      <property>/autopilot/locks/altitude</property>
      <value>altitude-hold</value>
    </enable>
    <input>
      <property>/autopilot/internal/altitude-5-sec-ahead</property>
    </input>
    <reference>
      <property>/instrumentation/my_aircraft/pfd/controls/target-alt</property>
    </reference>
    <gain>-8</gain>
    <output>
      <property>/autopilot/internal/target-climb-rate-fpm</property>
    </output>
    <min>
      <property>/instrumentation/my_aircraft/pfd/controls/vs-min</property>
    </min>
    <max>
      <property>/instrumentation/my_aircraft/pfd/controls/vs-max</property>
    </max>
  </filter>
  <pid-controller>
    <name>Altitude Capture/Hold</name>
    <debug>false</debug>
    <enable>
      <property>/autopilot/locks/altitude</property>
      <value>altitude-hold</value>
    </enable>
    <input>
      <property>/autopilot/internal/vert-speed-fpm</property>
      <scale>0.16667</scale> <!-- feet per minute to feet per second-->
    </input>
    <reference>
      <property>/autopilot/internal/target-climb-rate-fpm</property>
      <scale>0.16667</scale> <!-- feet per minute to feet per second-->
    </reference>
    <output>
      <property>/autopilot/internal/target-pitch-deg</property>
    </output>
    <config>
      <Kp>0.01</Kp>
      <beta>1.0</beta>
      <alpha>0.1</alpha>
      <gamma>0.0</gamma>
      <Ti>4.0</Ti>
      <Td>0.0001</Td>
      <u_min>-25.0</u_min>
      <u_max>40.0</u_max>
    </config>
  </pid-controller>
  
  <!-- ~~~~~~~~~~~~~~~~~~ vspeed -->
  <filter>
    <name>Altitude Capture/Hold Difference</name>
    <debug>false</debug>
    <type>gain</type>
    <gain>1</gain>
    <enable>
      <property>/autopilot/locks/altitude</property>
      <value>vertical-speed-hold</value>
    </enable>
    <input>
      <property>/instrumentation/my_aircraft/pfd/controls/target-vs</property>
    </input>
    <output>
      <property>/autopilot/internal/target-climb-rate-fpm</property>
    </output>
  </filter>
  <pid-controller>
    <name>Vertical Speed/Hold</name>
    <debug>false</debug>
    <enable>
      <property>/autopilot/locks/altitude</property>
      <value>vertical-speed-hold</value>
    </enable>
    <input>
      <property>/autopilot/internal/vert-speed-fpm</property>
      <scale>0.16667</scale> <!-- feet per minute to feet per second-->
    </input>
    <reference>
      <property>/autopilot/internal/target-climb-rate-fpm</property>
      <scale>0.16667</scale> <!-- feet per minute to feet per second-->
    </reference>
    <output>
      <property>/autopilot/internal/target-pitch-deg</property>
    </output>
    <config>
<!--
@hardball here is my tip:
start with Ti of 1000000000 and Td of 0
then adjust Kp until it reacts decently, but it may not be perfect.
But, it should not oscilate.
then, begin reducing Ti (which is time, not gain), until the steady state error is being corrected (the more time goes by, the more the integrator will output)
I usually end up in around 1-10 ish, depending on the controller
Then, you can adjust Td bringing it up very slightly, byut 0.00001 increments, which will make the controller more stable, and then very unstable, so I usually bring D up until the reaction begins to get oscilation, then I take it off a little.
remember that unlike normal PIDs used in most other programs, FG's  PID uses Ti and Td variables, so it's TIME, not a gain, like Kp is.
less Ti is more I action
more Td is more D action
I also suggest you to use rate based control over degree based control. its more stable, especially in bad weather.
-->
      <Kp>0.05</Kp>
      <beta>1.0</beta>
      <alpha>0.1</alpha>
      <gamma>0.0</gamma>
      <Ti>4.0</Ti>
      <Td>0.0001</Td>
      <u_min>-25.0</u_min>
      <u_max>40.0</u_max>
    </config>
  </pid-controller>

  <pid-controller>
    <name>System Command: Pitch</name>
    <debug>false</debug>
    <enable>
      <condition>
        <or>
          <equals>
            <property>/autopilot/locks/altitude</property>
            <value>altitude-hold</value>
          </equals>
          <equals>
            <property>/autopilot/locks/altitude</property>
            <value>vertical-speed-hold</value>
          </equals>
        </or>
      </condition>
    </enable>
    <input>
      <property>/orientation/pitch-deg</property>
    </input>
    <reference>
      <property>/autopilot/internal/target-pitch-deg</property>
    </reference>
    <output>
      <property>/controls/flight/elevator-ap</property>
    </output>
    <config>
      <Kp>-0.015</Kp>
      <beta>1.0</beta>
      <alpha>0.1</alpha>
      <gamma>0.0</gamma>
      <Ti>5.0</Ti>
      <Td>0.0001</Td>
      <u_min>-0.3</u_min>
      <u_max>0.3</u_max>
    </config>
  </pid-controller>
  
  <filter>
    <name>System Command: Pitch Sync</name>
    <debug>false</debug>
    <type>gain</type>
    <gain>1</gain>
    <enable>
      <condition>
        <not>
          <equals>
            <property>/autopilot/locks/altitude</property>
            <value>altitude-hold</value>
          </equals>
          <equals>
            <property>/autopilot/locks/altitude</property>
            <value>vertical-speed-hold</value>
          </equals>
        </not>
      </condition>
    </enable>
    <input>/orientation/pitch-deg</input>
    <output>/autopilot/internal/target-pitch-deg</output>
    <min>-25.0</min>
    <max>35.0</max>
  </filter>
  
  <filter>
    <name>System Command: Elevator</name>
    <debug>false</debug>
    <type>noise-spike</type>
    <enable>
      <condition>
        <or>
          <equals>
            <property>/autopilot/locks/altitude</property>
            <value>altitude-hold</value>
          </equals>
          <equals>
            <property>/autopilot/locks/altitude</property>
            <value>vertical-speed-hold</value>
          </equals>
        </or>
      </condition>
    </enable>
    <input>controls/flight/elevator-ap</input>
    <output>controls/flight/elevator</output>
    <max-rate-of-change>0.4</max-rate-of-change>
  </filter>

</PropertyList>



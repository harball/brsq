<?xml version="1.0" encoding="utf-8"?>
<!--
################################################################################
#
#             THIS FILE DEFINES THE AUTOPILOT BEHAVIOUR
#
################################################################################

http://www.flightgear.org/Docs/XMLAutopilot/node4.html
file Aircraft/Generic/generic-autopilot-helper.xml

- alpha     Filter time weighing factor (default = 0.1)
- beta      Proportional weighing factor (default = 1)
- gamma     Unfiltered derivative error weighing factor (default = 0)
- Kp        Proportional gain
- Ts        Sampling interval
- Ti        Integrator time
- Td        Derivator time
- u_min     Minimum output value
- u_max     Maximum output value

P : present, le gain agit sur la rapidite de correction
D : futur, permet d anticiper et eviter l overshoot
I : passe, corrige les perturbations

changelog
- 2016-10-22 : create
- 2017-07-20 : total refactoring by Joshua Davidson (it0uchpods)

-->

<PropertyList>

  <!--
________________________________________________________________________________
                                                                           SPEED
  -->

  <!-- ~~~~~~~~~~~~~~~~~~ auto-throttle -->
  <pid-controller>
    <name>IAS Hold</name>
    <debug>false</debug>
    <enable>
      <property>/autopilot/locks/speed</property>
      <value>speed-with-throttle</value>
    </enable>
    <input>
      <property>/instrumentation/airspeed-indicator/true-speed-kt</property>
    </input>
    <reference>
      <property>/autopilot/settings/target-speed-kt</property>
    </reference>
    <output>
      <property>/controls/engines/engine[0]/throttle</property>
      <property>/controls/engines/engine[1]/throttle</property>
    </output>
    <config>
      <Kp>0.1</Kp>
      <Ti>9</Ti>
      <Td>0.001</Td>
      <u_min>0.0</u_min>
      <u_max>1.0</u_max>
    </config>
  </pid-controller>

  <!--
________________________________________________________________________________
                                                                      HORIZONTAL
  -->

  <!-- ~~~~~~~~~~~~~~~~~~ heading bug -->
  <pi-simple-controller>
    <name>Heading Bug Hold (DG based)</name>
    <debug>false</debug>
    <enable>
      <property>/autopilot/locks/heading</property>
      <value>dg-heading-hold</value>
    </enable>
    <input>
      <property>/autopilot/internal/heading-bug-error-deg</property>
      <scale>1.5</scale>
    </input>
    <reference>
      <value>0.0</value>
    </reference>
    <output>
      <property>/autopilot/internal/target-roll-deg</property>
    </output>
    <config>
      <Kp>-1.2</Kp>
      <Ki>0.0</Ki>
      <min>-30.0</min>
      <max>30.0</max>
    </config>
  </pi-simple-controller>
  
  <!-- ~~~~~~~~~~~~~~~~~~ nav radial -->
  <pi-simple-controller>
    <name>NAV 1 Hold</name>
    <debug>false</debug>
    <enable>
      <property>/autopilot/locks/heading</property>
      <value>nav1-hold</value>
    </enable>
    <input>
      <property>autopilot/internal/nav1-heading-error-deg</property>
    </input>
    <reference>
      <value>0.0</value>
    </reference>
    <output>
      <property>autopilot/internal/target-roll-deg</property>
    </output>
    <config>
      <Kp>-1</Kp>
      <Ki>0.00001</Ki>
      <min>-30.0</min>
      <max>30.0</max>
    </config>
  </pi-simple-controller>
  
  <pid-controller>
    <name>system_command_roll</name>
    <debug>false</debug>
    <enable>
      <condition>
        <or>
          <equals>
            <property>/autopilot/locks/heading</property>
            <value>dg-heading-hold</value>
          </equals>
          <equals>
            <property>/autopilot/locks/heading</property>
            <value>nav1-hold</value>
          </equals>
        </or>
      </condition>
    </enable>
    <input>
      <property>/orientation/roll-deg</property>
    </input>
    <reference>
      <property>/autopilot/internal/target-roll-deg</property>
    </reference>
    <output>
      <property>/controls/flight/aileron-ap</property>
    </output>
    <config>
      <Kp>0.005</Kp>
      <Ti>10.0</Ti>
      <Td>0.0001</Td>
      <u_min>-0.4</u_min>
      <u_max>0.4</u_max>
    </config>
  </pid-controller>
  
  <filter>
    <name>System Command: Roll Sync</name>
    <debug>false</debug>
    <type>gain</type>
    <gain>1</gain>
    <enable>
      <condition>
        <and>
          <not-equals>
            <property>/autopilot/locks/heading</property>
            <value>dg-heading-hold</value>
          </not-equals>
          <not-equals>
            <property>/autopilot/locks/heading</property>
            <value>nav1-hold</value>
          </not-equals>
        </and>
      </condition>
    </enable>
    <input>/orientation/roll-deg</input>
    <output>/autopilot/internal/target-roll-deg</output>
    <min>-30.0</min>
    <max>30.0</max>
  </filter>
  
  <filter>
    <name>System Command: Aileron</name>
    <debug>false</debug>
    <type>noise-spike</type>
    <enable>
      <condition>
        <or>
          <equals>
            <property>/autopilot/locks/heading</property>
            <value>dg-heading-hold</value>
          </equals>
          <equals>
            <property>/autopilot/locks/heading</property>
            <value>nav1-hold</value>
          </equals>
        </or>
      </condition>
    </enable>
    <input>controls/flight/aileron-ap</input>
    <output>controls/flight/aileron</output>
    <max-rate-of-change>0.8</max-rate-of-change>
  </filter>

  <!--
________________________________________________________________________________
                                                                        VERTICAL
  -->

  <!-- ~~~~~~~~~~~~~~~~~~ altitude -->
  <predict-simple>
    <name>Altitude 5 Seconds Ahead</name>
    <debug>false</debug>
    <input>/instrumentation/altimeter/indicated-altitude-ft</input>
    <output>/autopilot/internal/altitude-5-sec-ahead</output>
    <seconds>5.0</seconds>
    <filter-gain>0.0</filter-gain>
  </predict-simple>
  
  <filter>
    <name>Altitude Capture/Hold Difference</name>
    <debug>false</debug>
    <type>gain</type>
    <enable>
      <property>/autopilot/locks/altitude</property>
      <value>altitude-hold</value>
    </enable>
    <input>
      <property>/autopilot/internal/altitude-5-sec-ahead</property>
    </input>
    <reference>
      <property>/autopilot/settings/target-altitude-ft</property>
    </reference>
    <gain>-8</gain>
    <output>
      <property>/autopilot/internal/target-climb-rate-fpm</property>
    </output>
    <min>-4000</min>
    <max>4000</max>
  </filter>

  <pid-controller>
    <name>Altitude Capture/Hold</name>
    <debug>false</debug>
    <enable>
      <property>/autopilot/locks/altitude</property>
      <value>altitude-hold</value>
    </enable>
    <input>
      <property>/autopilot/internal/vert-speed-fpm</property>
      <scale>0.16667</scale>
    </input>
    <reference>
      <property>/autopilot/internal/target-climb-rate-fpm</property>
      <scale>0.16667</scale>
    </reference>
    <output>
      <property>autopilot/internal/target-pitch-deg</property>
    </output>
    <config>
      <Kp>0.01</Kp>
      <beta>1.0</beta>
      <alpha>0.1</alpha>
      <gamma>0.0</gamma>
      <Ti>4.0</Ti>
      <Td>0.0001</Td>
      <u_min>-15.0</u_min>
      <u_max>30.0</u_max>
    </config>
  </pid-controller>
  
  <pid-controller>
    <name>System Command: Pitch</name>
    <debug>false</debug>
    <enable>
      <property>/autopilot/locks/altitude</property>
      <value>altitude-hold</value>
    </enable>
    <input>
      <property>/orientation/pitch-deg</property>
    </input>
    <reference>
      <property>/autopilot/internal/target-pitch-deg</property>
    </reference>
    <output>
      <property>/controls/flight/elevator-ap</property>
    </output>
    <config>
      <Kp>-0.015</Kp>
      <beta>1.0</beta>
      <alpha>0.1</alpha>
      <gamma>0.0</gamma>
      <Ti>5.0</Ti>
      <Td>0.0001</Td>
      <u_min>-0.25</u_min>
      <u_max>0.25</u_max>
    </config>
  </pid-controller>
  
  <filter>
    <name>System Command: Pitch Sync</name>
    <debug>false</debug>
    <type>gain</type>
    <gain>1</gain>
    <enable>
      <condition>
        <not-equals>
          <property>/autopilot/locks/altitude</property>
          <value>altitude-hold</value>
        </not-equals>
      </condition>
    </enable>
    <input>/orientation/pitch-deg</input>
    <output>/autopilot/internal/target-pitch-deg</output>
    <min>-15.0</min>
    <max>30.0</max>
  </filter>
  
  <filter>
    <name>System Command: Elevator</name>
    <debug>false</debug>
    <type>noise-spike</type>
    <enable>
      <property>/autopilot/locks/altitude</property>
      <value>altitude-hold</value>
    </enable>
    <input>controls/flight/elevator-ap</input>
    <output>controls/flight/elevator</output>
    <max-rate-of-change>0.4</max-rate-of-change>
  </filter>

</PropertyList>


